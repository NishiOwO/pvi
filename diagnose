#!/usr/bin/env perl
# $Id$

my @compilers = ("clang", "gcc", "cc");

my $diag_cc = "";
my $diag_cflags = "";

my $flags = "";

sub path_find {
	my @pathlist = split(/:/, $ENV{"PATH"});
	if(-f $_[0]){
		return 1;
	}
	foreach my $path (@pathlist){
		if(-f $path . "/" . $_[0]){
			return 1;
		}
	}
	return 0;
}

sub test_program {
	open(IN, ">", "test.c");
	print IN "$_[0]";
	close(IN);
	my $out = `$diag_cc $diag_cflags -c -o test.o test.c 2>&1`;
	my $status = $?;

	unlink("test.c");
	unlink("test.o");

	return $status == 0;
}

sub check_header {
	my $ret = 1;
	my $flag = "have." . $_[0];
	$flag =~ s/\./_/g;
	$flag = uc($flag);
	print("Does $_[0] exist? ");
	if(test_program("#include <$_[0]>\n")){
		print("yes\n");
	}else{
		print("no\n");
		$ret = 0;
	}
	$diag_cflags = $diag_cflags . " -D$flag=$ret";
	return $ret;
}

if(defined($ENV{"CFLAGS"})){
	$diag_cflags = $ENV{"CFLAGS"};
}

if(defined($ENV{"CC"})){
	@compilers = reverse(@compilers);
	push(@compilers, $ENV{"CC"});
	@compilers = reverse(@compilers);
}

print("Diagnose " . '$Id$' . "\n");

print("What compiler do you have? ");
foreach my $cc (@compilers){
	if(path_find($cc)){
		print("$cc\n");
		$diag_cc = $cc;
		last;
	}
}

print("What compiler is this? ");
if(!test_program("#ifdef __clang__\nthis should fail\n#endif\n")){
	print("Clang\n");
}elsif(!test_program("#ifdef __GNUC__\nthis should fail\n#endif\n")){
	print("GCC\n");
}elsif(!test_program("#ifdef __USLC__\nthis should fail\n#endif\n")){
	print("UDK??\n");
}else{
	print("Unknown\n");
	print("This compiler is not supported yet\n");
	print("Contact maintainer or send patches\n");
	exit(1);
}

check_header("termios.h");
if(check_header("termcap.h")){
}elsif(check_header("windows.h")){
}
check_header("stdint.h");

print($diag_cflags . "\n");
